name: Android CI

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2

    - name: Set up JDK 8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Setup Gradle
      run: |
        chmod +x ./gradlew
        # Check gradle version
        ./gradlew --version

    - name: Check for gradle-wrapper.jar
      run: |
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "gradle-wrapper.jar is missing! Creating gradle wrapper..."
          mkdir -p gradle/wrapper
          gradle wrapper
        fi

    - name: Remove Android 33 preview platform
      run: |
        echo "Removing Android 33 preview platform to avoid build errors"
        rm -rf "$ANDROID_SDK_ROOT/platforms/android-33" || echo "No preview platform found"

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: List output files
      run: |
        echo "Listing output APK files:"
        find app/build/outputs/apk -type f -name "*.apk"

    - name: Upload APK manually
      run: |
        mkdir -p build-artifacts
        find app/build/outputs/apk -name "*.apk" -exec cp {} build-artifacts/ \;
        echo "APK files copied to build-artifacts directory"

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: blackblub-debug-apk
        path: build-artifacts